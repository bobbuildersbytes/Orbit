<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Orbit - Live Map</title>
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    />
    <link
      rel="stylesheet"
      href="https://unpkg.com/cropperjs@1.6.1/dist/cropper.min.css"
    />
    <link rel="stylesheet" href="/css/style.css" />
    <link rel="stylesheet" href="/css/edit-modal.css" />
  </head>
  <body>
    <!-- Inject User Data for Client-Side JS -->
    <script id="user-data-payload" type="application/json">
      <%- JSON.stringify(user) %>
    </script>
    <script>
      try {
        const payload =
          document.getElementById("user-data-payload").textContent;
        window.orbitUser = JSON.parse(payload);
      } catch (e) {
        console.error("Failed to parse user data", e);
        window.orbitUser = null;
      }
    </script>

    <div id="login-view" class="view-container hidden">
      <!-- Orbit handles login via separate pages, this is just a fallback/loading state if needed -->
      <div class="login-box">
        <h1>Loading Orbit...</h1>
      </div>
    </div>

    <div id="app-view" class="view-container">
      <aside id="sidebar" class="sidebar">
        <!-- Desktop Nav Rail -->
        <div class="sidebar-nav">
          <button
            class="nav-icon active"
            data-target="profile-panel"
            title="Profile"
          >
            <svg
              class="nav-icon-svg"
              xmlns="http://www.w3.org/2000/svg"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
              aria-hidden="true"
              focusable="false"
            >
              <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2" />
              <circle cx="12" cy="7" r="4" />
            </svg>
          </button>
          <button
            class="nav-icon"
            data-target="activities-panel"
            title="Friends"
          >
            <svg
              class="nav-icon-svg"
              xmlns="http://www.w3.org/2000/svg"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
              aria-hidden="true"
              focusable="false"
            >
              <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2" />
              <circle cx="9" cy="7" r="4" />
              <path d="M23 21v-2a4 4 0 0 0-3-3.87" />
              <path d="M16 3.13a4 4 0 0 1 0 7.75" />
            </svg>
          </button>
          <button
            class="nav-icon"
            data-target="suggestions-panel"
            title="Suggestions"
          >
            <svg
              class="nav-icon-svg"
              xmlns="http://www.w3.org/2000/svg"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
              aria-hidden="true"
              focusable="false"
            >
              <path
                d="M12 2a7 7 0 0 0-4 12c.5.5 1 1.5 1 2.5V18h6v-1.5c0-1 .5-2 1-2.5A7 7 0 0 0 12 2Z"
              />
              <path d="M9 18h6" />
              <path d="M10 22h4" />
            </svg>
          </button>
        </div>

        <div class="sidebar-content-wrapper">
          <div class="sidebar-header">
            <h2 id="sidebar-title">Profile & Settings</h2>
            <button
              id="sidebar-close-btn"
              class="icon-btn"
              aria-label="Close Sidebar"
            >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                width="24"
                height="24"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <line x1="19" y1="12" x2="5" y2="12"></line>
                <polyline points="12 19 5 12 12 5"></polyline>
              </svg>
            </button>
          </div>

          <div class="sidebar-content">
            <!-- Activities (Default Hidden) -->
            <div class="panel-section hidden" id="activities-panel">
              <div class="panel-header mobile-only">
                <h3>Friends</h3>
              </div>
              <div id="users-section">
                <div class="section-title">Friends</div>
                <div id="users-list">
                  <!-- Static Skeletons for Instant Load -->
                  <% for(let i=0; i<5; i++) { %>
                  <div class="user-card skeleton-card">
                    <div class="skeleton-info">
                      <div class="skeleton-text skeleton-title" style="width: 120px; margin-bottom: 4px;"></div>
                      <div class="skeleton-text" style="width: 80px;"></div>
                    </div>
                    <div class="skeleton-actions">
                       <div class="skeleton-btn"></div>
                       <div class="skeleton-btn"></div>
                    </div>
                  </div>
                  <% } %>
                </div>
                <script>
                  // Inline Critical View Toggle
                  // Runs immediately after this HTML is parsed
                  (function() {
                    try {
                      var login = document.getElementById('login-view');
                      var app = document.getElementById('app-view');
                      if (window.orbitUser) {
                        if (login) login.classList.add('hidden');
                        if (app) app.classList.remove('hidden');
                      } else {
                        // Logic handled by auth.js fallback/redirect usually
                      }
                    } catch(e) {}
                  })();
                </script>
              </div>
              <div class="spacer"></div>
              <!-- Orbit "Add Friend" Integration -->
              <div
                class="add-friend-section"
                style="
                  border-top: 1px solid var(--color-gray-200);
                  padding-top: var(--space-4);
                "
              >
                <div class="section-title">Add Friend</div>
                <div
                  style="
                    background: var(--color-gray-50);
                    padding: var(--space-2);
                    border-radius: var(--radius-md);
                    margin-bottom: var(--space-3);
                  "
                >
                  <small style="color: var(--color-gray-600)">Your ID:</small>
                  <div
                    style="
                      font-family: monospace;
                      font-size: var(--font-size-lg);
                      font-weight: bold;
                      color: var(--color-primary-600);
                    "
                  >
                    <%= user.uniqueId %>
                  </div>
                </div>
                <form
                  action="/add-friend"
                  method="POST"
                  style="display: flex; gap: var(--space-2)"
                >
                  <input
                    type="text"
                    name="code"
                    placeholder="Friend ID"
                    required
                    style="margin-top: 0"
                  />
                  <button type="submit" class="small">Add</button>
                </form>
              </div>
            </div>

            <!-- Suggestions Panel -->
            <div class="panel-section hidden" id="suggestions-panel">
              <div class="panel-header mobile-only">
                <h3>Suggestions</h3>
              </div>
              <div id="suggestions-section">
                <div
                  style="
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                    margin-bottom: var(--space-2);
                  "
                >
                  <div class="section-title" style="margin-bottom: 0">
                    AI Suggestions
                  </div>
                  <button
                    id="refresh-suggestions-btn"
                    class="icon-btn"
                    title="Refresh Suggestions"
                  >
                    <svg
                      class="icon-btn-svg"
                      xmlns="http://www.w3.org/2000/svg"
                      viewBox="0 0 24 24"
                      fill="none"
                      stroke="currentColor"
                      stroke-width="2"
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      aria-hidden="true"
                      focusable="false"
                    >
                      <path d="M21 12a9 9 0 0 0-15.5-6.5L3 8" />
                      <path d="M3 3v5h5" />
                      <path d="M3 12a9 9 0 0 0 15.5 6.5L21 16" />
                      <path d="M21 21v-5h-5" />
                    </svg>
                  </button>
                </div>
                <div id="suggestions-list">
                  <div class="muted">
                    Suggestions logic is currently initializing...
                  </div>
                </div>
              </div>
            </div>

            <!-- Profile (Default Visible) -->
            <div class="panel-section" id="profile-panel">
              <div
                class="panel-header mobile-only"
                style="
                  display: flex;
                  justify-content: space-between;
                  align-items: center;
                  margin-bottom: var(--space-4);
                "
              >
                <div>
                  <div
                    style="font-weight: bold; font-size: var(--font-size-lg)"
                  >
                    <%= user.firstName %> <%= user.lastName %>
                  </div>
                  <div
                    style="
                      color: var(--color-gray-500);
                      font-size: var(--font-size-sm);
                    "
                  >
                    <%= user.email %>
                  </div>
                </div>
                <button id="logout-btn-mobile" class="secondary small">
                  Logout
                </button>
              </div>
              <div
                class="panel-header desktop-only-flex"
                style="
                  display: flex;
                  justify-content: space-between;
                  align-items: center;
                  margin-bottom: var(--space-4);
                "
              >
                <div>
                  <div
                    style="font-weight: bold; font-size: var(--font-size-lg)"
                  >
                    <%= user.firstName %> <%= user.lastName %>
                  </div>
                  <div
                    style="
                      color: var(--color-gray-500);
                      font-size: var(--font-size-sm);
                    "
                  >
                    <%= user.email %>
                  </div>
                </div>
                <button id="logout-btn" class="secondary small">Logout</button>
              </div>

              <div style="text-align: center; margin-bottom: var(--space-4)">
                <img
                  id="current-profile-pic"
                  src="<%= user.profilePicture || 'data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 width=%22120%22 height=%22120%22 viewBox=%220 0 24 24%22 fill=%22none%22 stroke=%22%23666%22 stroke-width=%222%22><circle cx=%2212%22 cy=%228%22 r=%224%22/><path d=%22M6 21v-2a4 4 0 0 1 4-4h4a4 4 0 0 1 4 4v2%22/></svg>' %>"
                  alt="Profile Picture"
                  style="
                    width: 120px;
                    height: 120px;
                    border-radius: 50%;
                    object-fit: cover;
                    border: 3px solid #3b82f6;
                    margin-bottom: var(--space-2);
                  "
                />
                <form
                  id="update-profile-pic-form"
                  style="margin-top: var(--space-3)"
                >
                  <input
                    type="file"
                    id="new-profile-picture"
                    accept="image/*"
                    style="display: none"
                  />
                  <button
                    type="button"
                    id="choose-pic-btn"
                    class="secondary"
                    style="width: 100%"
                  >
                    Change Profile Picture
                  </button>
                </form>
                <canvas
                  id="crop-canvas"
                  style="
                    display: none;
                    max-width: 100%;
                    margin-top: var(--space-3);
                    border: 1px solid #ccc;
                  "
                ></canvas>
                <div
                  id="crop-controls"
                  style="
                    display: none;
                    gap: var(--space-2);
                    margin-top: var(--space-2);
                  "
                >
                  <button
                    type="button"
                    id="save-cropped-pic"
                    style="width: 100%"
                  >
                    Save
                  </button>
                  <button
                    type="button"
                    id="cancel-crop"
                    class="secondary"
                    style="width: 100%"
                  >
                    Cancel
                  </button>
                </div>
              </div>

              <div id="presence-section">
                <button
                  id="available-btn"
                  class="available-btn hidden-state"
                  style="width: 100%; margin-bottom: var(--space-2)"
                >
                  Location: Hidden
                </button>
                <div class="location-controls">
                  <button
                    id="busy-btn"
                    class="available-btn hidden-state hidden"
                    style="width: 100%"
                  >
                    Status: Available
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </aside>

      <!-- Main Content Area -->
      <main id="main-content">
        <button
          id="sidebar-toggle-mobile"
          class="mobile-only icon-btn"
          style="
            position: absolute;
            top: var(--space-4);
            left: var(--space-4);
            z-index: 1000;
            background: white;
            border-radius: 50%;
            box-shadow: var(--shadow-md);
          "
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            width="24"
            height="24"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
          >
            <line x1="3" y1="12" x2="21" y2="12"></line>
            <line x1="3" y1="6" x2="21" y2="6"></line>
            <line x1="3" y1="18" x2="21" y2="18"></line>
          </svg>
        </button>
        <div id="map"></div>
        <button
          id="desktop-sidebar-toggle"
          class="icon-btn desktop-fab hidden"
          aria-label="Toggle Sidebar"
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            width="24"
            height="24"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
          >
            <line x1="3" y1="12" x2="21" y2="12"></line>
            <line x1="3" y1="6" x2="21" y2="6"></line>
            <line x1="3" y1="18" x2="21" y2="18"></line>
          </svg>
        </button>

        <!-- Mobile Side Navigation -->
        <div id="mobile-side-nav" class="mobile-only" aria-label="Navigation">
          <button
            class="mobile-nav-icon"
            data-target="activities-panel"
            aria-label="Friends"
          >
            <svg
              class="nav-icon-svg"
              xmlns="http://www.w3.org/2000/svg"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
              aria-hidden="true"
              focusable="false"
            >
              <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2" />
              <circle cx="9" cy="7" r="4" />
              <path d="M23 21v-2a4 4 0 0 0-3-3.87" />
              <path d="M16 3.13a4 4 0 0 1 0 7.75" />
            </svg>
          </button>
          <button
            class="mobile-nav-icon active"
            data-target="profile-panel"
            aria-label="Profile"
          >
            <svg
              class="nav-icon-svg"
              xmlns="http://www.w3.org/2000/svg"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
              aria-hidden="true"
              focusable="false"
            >
              <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2" />
              <circle cx="12" cy="7" r="4" />
            </svg>
          </button>
          <button
            class="mobile-nav-icon"
            data-target="suggestions-panel"
            aria-label="Suggestions"
          >
            <svg
              class="nav-icon-svg"
              xmlns="http://www.w3.org/2000/svg"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
              aria-hidden="true"
              focusable="false"
            >
              <path
                d="M12 2a7 7 0 0 0-4 12c.5.5 1 1.5 1 2.5V18h6v-1.5c0-1 .5-2 1-2.5A7 7 0 0 0 12 2Z"
              />
              <path d="M9 18h6" />
              <path d="M10 22h4" />
            </svg>
          </button>
        </div>

        <div
          id="mobile-drawer-backdrop"
          class="mobile-only hidden"
          aria-hidden="true"
        ></div>

        <!-- Mobile Bottom Nav -->
        <nav id="bottom-nav" class="mobile-only">
          <button class="nav-item active" data-target="profile-panel">
            <span class="icon" aria-hidden="true">
              <svg
                class="nav-item-svg"
                xmlns="http://www.w3.org/2000/svg"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
                focusable="false"
              >
                <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2" />
                <circle cx="12" cy="7" r="4" />
              </svg>
            </span>
            <span>Profile</span>
          </button>
          <button class="nav-item" data-target="activities-panel">
            <span class="icon" aria-hidden="true">
              <svg
                class="nav-item-svg"
                xmlns="http://www.w3.org/2000/svg"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
                focusable="false"
              >
                <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2" />
                <circle cx="9" cy="7" r="4" />
                <path d="M23 21v-2a4 4 0 0 0-3-3.87" />
                <path d="M16 3.13a4 4 0 0 1 0 7.75" />
              </svg>
            </span>
            <span>Friends</span>
          </button>
          <button class="nav-item" data-target="suggestions-panel">
            <span class="icon" aria-hidden="true">
              <svg
                class="nav-item-svg"
                xmlns="http://www.w3.org/2000/svg"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
                focusable="false"
              >
                <path
                  d="M12 2a7 7 0 0 0-4 12c.5.5 1 1.5 1 2.5V18h6v-1.5c0-1 .5-2 1-2.5A7 7 0 0 0 12 2Z"
                />
                <path d="M9 18h6" />
                <path d="M10 22h4" />
              </svg>
            </span>
            <span>Ideas</span>
          </button>
        </nav>
      </main>

      <div id="mobile-sheet-overlay" class="hidden">
        <div class="sheet-content" id="sheet-container">
          <!-- Content will be swapped or shown here via JS logic/CSS -->
        </div>
        <button id="close-sheet-btn">Ã—</button>
      </div>

      <!-- Paging Modal (Custom UI Replacement for Prompt) -->
      <div id="pager-modal-overlay" class="pager-modal-overlay hidden">
        <div class="pager-modal">
          <h3 class="pager-title">Page Friend</h3>
          <p class="pager-subtitle">
            Send a quick message to let them know you're looking for them.
          </p>
          <textarea
            id="pager-message-input"
            class="pager-textarea"
            placeholder="Type your message here... (optional)"
            rows="3"
          ></textarea>
          <div class="pager-actions">
            <button id="pager-cancel-btn" class="secondary">Cancel</button>
            <button id="pager-send-btn">Send Page</button>
          </div>
        </div>
      </div>
      <!-- Edit Suggestion Modal -->
      <div
        id="edit-suggestion-modal-overlay"
        class="pager-modal-overlay hidden"
      >
        <div class="pager-modal" id="edit-modal-content">
          <div class="invite-header">
            <div style="flex: 1">
              <div class="invite-title" id="edit-modal-title">
                Edit Suggestion
              </div>
              <div class="invite-detail" id="edit-modal-subtitle">
                Update details or choose a different friend.
              </div>
            </div>
          </div>
          <div
            class="invite-confidence"
            id="edit-modal-confidence"
            style="display: none; margin-bottom: 12px"
          ></div>

          <label
            id="edit-step1-label"
            style="
              display: block;
              margin-bottom: 8px;
              font-weight: 600;
              color: var(--color-gray-700);
            "
            >Select Friend:</label
          >
          <div
            id="edit-friend-list"
            class="friend-multiselect invite-list"
            style="
              display: flex;
              flex-direction: column;
              gap: 4px;
              border: 1px solid rgba(0, 0, 0, 0.05);
              padding: 0;
              border-radius: 8px;
              background: transparent;
            "
          >
            <!-- Checkboxes injected by JS -->
          </div>

          <label
            id="edit-step2-label"
            style="
              display: block;
              margin-bottom: 8px;
              font-weight: 600;
              color: var(--color-gray-700);
            "
            >Details (e.g. time/place):</label
          >
          <textarea
            id="edit-suggestion-detail"
            class="pager-textarea"
            rows="3"
          ></textarea>

          <div class="pager-actions">
            <button id="edit-cancel-btn" class="secondary">Cancel</button>
            <button id="edit-save-btn">Save Changes</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Scripts -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/cropperjs@1.6.1/dist/cropper.min.js"></script>
    <script type="text/javascript">
      (function (e, t) {
        var n = e.amplitude || { _q: [], _iq: {} };
        var r = t.createElement("script");
        r.type = "text/javascript";
        r.async = true;
        r.src = "https://cdn.amplitude.com/libs/amplitude-8.21.4-min.gz.js";
        r.onload = function () {
          if (!e.amplitude.runQueuedFunctions) {
            console.log("[Amplitude] Error: could not load SDK");
          }
        };
        var i = t.getElementsByTagName("script")[0];
        i.parentNode.insertBefore(r, i);
        function s(e, t) {
          e.prototype[t] = function () {
            this._q.push([t].concat(Array.prototype.slice.call(arguments, 0)));
            return this;
          };
        }
        var o = function () {
          this._q = [];
          return this;
        };
        var a = [
          "add",
          "append",
          "clearAll",
          "prepend",
          "set",
          "setOnce",
          "unset",
          "preInsert",
          "postInsert",
          "remove",
        ];
        for (var c = 0; c < a.length; c++) {
          s(o, a[c]);
        }
        n.Identify = o;
        var u = function () {
          this._q = [];
          return this;
        };
        var l = [
          "setProductId",
          "setQuantity",
          "setPrice",
          "setRevenueType",
          "setEventProperties",
        ];
        for (var p = 0; p < l.length; p++) {
          s(u, l[p]);
        }
        n.Revenue = u;
        var d = [
          "init",
          "logEvent",
          "logRevenue",
          "setUserId",
          "setUserProperties",
          "setOptOut",
          "setVersionName",
          "setDomain",
          "setDeviceId",
          "enableTracking",
          "setGlobalUserProperties",
          "identify",
          "clearUserProperties",
          "setGroup",
          "logRevenueV2",
          "regenerateDeviceId",
          "groupIdentify",
          "onInit",
          "logEventWithTimestamp",
          "logEventWithGroups",
          "setSessionId",
          "resetSessionId",
        ];
        function v(e) {
          function t(t) {
            e[t] = function () {
              e._q.push([t].concat(Array.prototype.slice.call(arguments, 0)));
            };
          }
          for (var n = 0; n < d.length; n++) {
            t(d[n]);
          }
        }
        v(n);
        n.getInstance = function (e) {
          e = (!e || e.length === 0 ? "$default_instance" : e).toLowerCase();
          if (!n._iq.hasOwnProperty(e)) {
            n._iq[e] = { _q: [] };
            v(n._iq[e]);
          }
          return n._iq[e];
        };
        e.amplitude = n;
      })(window, document);
    </script>
    <script src="/js/amplitude.js"></script>
    <script src="/js/auth.js"></script>
    <script src="/js/map.js"></script>
    <script src="/js/suggestions.js"></script>
    <script src="/js/app.js"></script>
    <script>
      // Profile Picture Update Logic
      let profileCropper = null;
      const choosePicBtn = document.getElementById("choose-pic-btn");
      const newProfilePicInput = document.getElementById("new-profile-picture");
      const cropCanvas = document.getElementById("crop-canvas");
      const cropControls = document.getElementById("crop-controls");
      const saveCroppedPicBtn = document.getElementById("save-cropped-pic");
      const cancelCropBtn = document.getElementById("cancel-crop");
      const currentProfilePic = document.getElementById("current-profile-pic");

      choosePicBtn?.addEventListener("click", () => {
        newProfilePicInput.click();
      });

      newProfilePicInput?.addEventListener("change", (e) => {
        const file = e.target.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = (event) => {
            cropCanvas.style.display = "block";
            cropControls.style.display = "flex";
            choosePicBtn.style.display = "none";

            const img = new Image();
            img.onload = () => {
              const canvas = cropCanvas;
              const ctx = canvas.getContext("2d");

              if (profileCropper) {
                profileCropper.destroy();
              }

              canvas.width = img.width;
              canvas.height = img.height;
              ctx.drawImage(img, 0, 0);

              profileCropper = new Cropper(canvas, {
                aspectRatio: 1,
                viewMode: 1,
                autoCropArea: 1,
                responsive: true,
                background: false,
              });
            };
            img.src = event.target.result;
          };
          reader.readAsDataURL(file);
        }
      });

      saveCroppedPicBtn?.addEventListener("click", async () => {
        if (profileCropper) {
          const canvas = profileCropper.getCroppedCanvas({
            width: 400,
            height: 400,
          });

          canvas.toBlob(async (blob) => {
            const formData = new FormData();
            formData.append("profilePicture", blob, "profile.jpg");

            try {
              const res = await fetch("/update-profile-picture", {
                method: "POST",
                body: formData,
              });

              console.log("Response status:", res.status);
              const data = await res.json();
              console.log("Response data:", data);

              if (res.ok) {
                currentProfilePic.src = data.base64;
                resetCropUI();
                alert("Profile picture updated!");
              } else {
                console.error("Server error:", data);
                alert(
                  "Failed to update profile picture: " +
                    (data.error || "Unknown error"),
                );
              }
            } catch (err) {
              console.error("Fetch error:", err);
              alert("Error updating profile picture: " + err.message);
            }
          });
        }
      });

      cancelCropBtn?.addEventListener("click", () => {
        resetCropUI();
      });

      function resetCropUI() {
        cropCanvas.style.display = "none";
        cropControls.style.display = "none";
        choosePicBtn.style.display = "block";
        newProfilePicInput.value = "";
        if (profileCropper) {
          profileCropper.destroy();
          profileCropper = null;
        }
      }
    </script>
  </body>
</html>
